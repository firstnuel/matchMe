<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .log { background: #f5f5f5; padding: 10px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .input-group { margin: 10px 0; }
        .input-group label { display: inline-block; width: 150px; }
        .input-group input { width: 300px; padding: 5px; }
        .button { background: #007bff; color: white; padding: 8px 16px; border: none; border-radius: 3px; cursor: pointer; }
        .button:hover { background: #0056b3; }
        .button:disabled { background: #ccc; cursor: not-allowed; }
        .status { padding: 5px; margin: 5px 0; border-radius: 3px; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebSocket Test Page</h1>
        
        <div class="section">
            <h3>Configuration</h3>
            <div class="input-group">
                <label>Auth Token:</label>
                <input type="text" id="authToken" placeholder="Paste your auth token here">
            </div>
            <div class="input-group">
                <label>Connection ID:</label>
                <input type="text" id="connectionId" placeholder="eaa31d6d-d265-4d58-85d7-362588ac6361">
            </div>
            <div class="input-group">
                <label>Server URL:</label>
                <input type="text" id="serverUrl" value="ws://localhost:3000">
            </div>
        </div>

        <div class="section">
            <h3>WebSocket Connections</h3>
            <div>
                <button class="button" onclick="connectChat()">Connect Chat WebSocket</button>
                <button class="button" onclick="connectTyping()">Connect Typing WebSocket</button>
                <button class="button" onclick="disconnectAll()">Disconnect All</button>
            </div>
            <div style="margin-top: 10px;">
                <div class="status" id="chatStatus">Chat WebSocket: Disconnected</div>
                <div class="status" id="typingStatus">Typing WebSocket: Disconnected</div>
            </div>
        </div>

        <div class="section">
            <h3>Send Test Messages</h3>
            <div class="input-group">
                <label>Test Message:</label>
                <input type="text" id="testMessage" placeholder="Hello World" value="Test message from HTML">
            </div>
            <div>
                <button class="button" onclick="sendTypingEvent(true)">Send Typing Start</button>
                <button class="button" onclick="sendTypingEvent(false)">Send Typing Stop</button>
                <button class="button" onclick="sendChatMessage()">Send Chat Message</button>
            </div>
        </div>

        <div class="section">
            <h3>Event Log</h3>
            <button class="button" onclick="clearLog()">Clear Log</button>
            <div class="log" id="eventLog"></div>
        </div>
    </div>

    <script>
        let chatWS = null;
        let typingWS = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('eventLog');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#d32f2f' : type === 'success' ? '#2e7d32' : type === 'warn' ? '#f57c00' : '#1976d2';
            logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('eventLog').innerHTML = '';
        }
        
        function updateStatus(type, status, connected) {
            const statusDiv = document.getElementById(type + 'Status');
            statusDiv.textContent = `${type.charAt(0).toUpperCase() + type.slice(1)} WebSocket: ${status}`;
            statusDiv.className = 'status ' + (connected ? 'connected' : 'disconnected');
        }
        
        function connectChat() {
            const authToken = document.getElementById('authToken').value;
            const connectionId = document.getElementById('connectionId').value;
            const serverUrl = document.getElementById('serverUrl').value;
            
            if (!authToken || !connectionId) {
                alert('Please provide auth token and connection ID');
                return;
            }
            
            if (chatWS) {
                chatWS.close();
            }
            
            const url = `${serverUrl}/ws/chat/${connectionId}?token=${encodeURIComponent(authToken)}`;
            log(`üîå Connecting to chat WebSocket: ${url}`);
            
            chatWS = new WebSocket(url);
            
            chatWS.onopen = function(event) {
                log('‚úÖ Chat WebSocket connected', 'success');
                updateStatus('chat', 'Connected', true);
            };
            
            chatWS.onmessage = function(event) {
                log(`üì® Chat message received: ${event.data}`, 'success');
                try {
                    const message = JSON.parse(event.data);
                    log(`üì® Parsed chat message - Type: ${message.type}, Data: ${JSON.stringify(message.data)}`, 'success');
                } catch (e) {
                    log(`‚ö†Ô∏è Failed to parse chat message: ${e.message}`, 'warn');
                }
            };
            
            chatWS.onclose = function(event) {
                log(`‚ùå Chat WebSocket closed - Code: ${event.code}, Reason: ${event.reason}`, 'error');
                updateStatus('chat', 'Disconnected', false);
            };
            
            chatWS.onerror = function(event) {
                log(`‚ùå Chat WebSocket error: ${JSON.stringify(event)}`, 'error');
                updateStatus('chat', 'Error', false);
            };
        }
        
        function connectTyping() {
            const authToken = document.getElementById('authToken').value;
            const connectionId = document.getElementById('connectionId').value;
            const serverUrl = document.getElementById('serverUrl').value;
            
            if (!authToken || !connectionId) {
                alert('Please provide auth token and connection ID');
                return;
            }
            
            if (typingWS) {
                typingWS.close();
            }
            
            const url = `${serverUrl}/ws/typing/${connectionId}?token=${encodeURIComponent(authToken)}`;
            log(`‚å®Ô∏è Connecting to typing WebSocket: ${url}`);
            
            typingWS = new WebSocket(url);
            
            typingWS.onopen = function(event) {
                log('‚úÖ Typing WebSocket connected', 'success');
                updateStatus('typing', 'Connected', true);
            };
            
            typingWS.onmessage = function(event) {
                log(`‚å®Ô∏è Typing message received: ${event.data}`, 'success');
                try {
                    const message = JSON.parse(event.data);
                    log(`‚å®Ô∏è Parsed typing message - Type: ${message.type}, Data: ${JSON.stringify(message.data)}`, 'success');
                } catch (e) {
                    log(`‚ö†Ô∏è Failed to parse typing message: ${e.message}`, 'warn');
                }
            };
            
            typingWS.onclose = function(event) {
                log(`‚ùå Typing WebSocket closed - Code: ${event.code}, Reason: ${event.reason}`, 'error');
                updateStatus('typing', 'Disconnected', false);
            };
            
            typingWS.onerror = function(event) {
                log(`‚ùå Typing WebSocket error: ${JSON.stringify(event)}`, 'error');
                updateStatus('typing', 'Error', false);
            };
        }
        
        function sendTypingEvent(isTyping) {
            if (!typingWS || typingWS.readyState !== WebSocket.OPEN) {
                log('‚ùå Typing WebSocket not connected', 'error');
                return;
            }
            
            const connectionId = document.getElementById('connectionId').value;
            const message = {
                type: 'message_typing',
                data: {
                    connection_id: connectionId,
                    user_id: 'test-user-id', // This would normally come from your user context
                    is_typing: isTyping,
                    updated_at: new Date().toISOString()
                },
                timestamp: new Date().toISOString(),
                message_id: Math.random().toString(36).substring(2, 15)
            };
            
            log(`üì§ Sending typing event: ${JSON.stringify(message)}`);
            typingWS.send(JSON.stringify(message));
        }
        
        function sendChatMessage() {
            log('‚ÑπÔ∏è Chat messages should be sent via REST API, not WebSocket', 'warn');
            log('üí° Use your React app to send a message and watch for broadcasts here', 'info');
        }
        
        function disconnectAll() {
            if (chatWS) {
                chatWS.close();
                chatWS = null;
            }
            if (typingWS) {
                typingWS.close();
                typingWS = null;
            }
            log('üîå Disconnected all WebSockets');
            updateStatus('chat', 'Disconnected', false);
            updateStatus('typing', 'Disconnected', false);
        }
        
        // Set default connection ID if provided
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const connectionId = urlParams.get('connectionId');
            if (connectionId) {
                document.getElementById('connectionId').value = connectionId;
            }
        });
    </script>
</body>
</html>